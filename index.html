<!DOCTYPE html>
<html>
<head>
  <title>Telegram WebApp Data Parsing</title>
  <meta charset="UTF-8" />
</head>
<body>
  <h1>Telegram WebApp Data Parsing Demo</h1>
  <pre id="display"></pre>

  <script>
    // 1) Parse standard query params from window.location.search
    const urlSearchParams = new URLSearchParams(window.location.search);
    // Example usage:
    const tgWebAppStartParam = urlSearchParams.get('tgWebAppStartParam'); // e.g. "-1002491175041"
    const tgWebAppVersion = urlSearchParams.get('tgWebAppVersion');       // e.g. "8.0"
    // ...and so on

    // 2) Parse hash fragment (e.g. "#tgWebAppData=...")
    // window.location.hash might look like:
    // "#tgWebAppData=user%3D%257B%2522id%2522%253A..."
    // So first remove leading "#" and parse with URLSearchParams
    const hashString = window.location.hash.replace(/^#/, '');
    const hashParams = new URLSearchParams(hashString);

    // The Telegram data is typically in "tgWebAppData"
    const tgWebAppData = hashParams.get('tgWebAppData');
    let parsedTelegramData = {};

    if (tgWebAppData) {
      // 3) Telegram’s data is itself URL-encoded, so decode it
      // The decoded string may look like:
      // "user=%7B%22id%22%3A260423037%2C%22first_name%22%3A%22Ruslan%22%2C...&chat_instance=..."
      const decoded = decodeURIComponent(tgWebAppData);

      // 4) Turn that decoded string into structured data
      // by creating a new URLSearchParams object
      const tgParams = new URLSearchParams(decoded);

      // Example: "user" param is JSON with user info
      const rawUserJson = tgParams.get('user');  
      const chatInstance = tgParams.get('chat_instance');
      const startParam = tgParams.get('start_param');
      const authDate = tgParams.get('auth_date');
      const signature = tgParams.get('signature');
      const hash = tgParams.get('hash');

      let userData = {};
      if (rawUserJson) {
        try {
          userData = JSON.parse(rawUserJson);
        } catch (err) {
          console.error("Error parsing user JSON:", err);
        }
      }

      parsedTelegramData = {
        userData,
        chat_instance: chatInstance,
        start_param: startParam,
        auth_date: authDate,
        signature,
        hash
      };
    }

    // Display everything in the <pre> for demonstration
    // (In a real app, you’d handle these parameters in your logic)
    const displayEl = document.getElementById('display');
    displayEl.textContent = JSON.stringify({
      queryParams: Object.fromEntries(urlSearchParams.entries()),
      hashParams: Object.fromEntries(hashParams.entries()),
      parsedTelegramData
    }, null, 2);
  </script>
</body>
</html>
